name: Version Check

on:
  schedule:
    # Run every day at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  check-version:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm wget p7zip grep
    
    - name: Check for new version
      id: check
      run: |
        chmod +x check-version.sh
        
        # Run version checker and capture output
        if ./check-version.sh > version-check.log 2>&1; then
          echo "up_to_date=true" >> $GITHUB_OUTPUT
          echo "Version is up to date"
        else
          echo "up_to_date=false" >> $GITHUB_OUTPUT
          
          # Extract version info from log
          CURRENT=$(grep "Current packaged version:" version-check.log | cut -d: -f2 | tr -d ' ')
          LATEST=$(grep "Latest available version:" version-check.log | cut -d: -f2 | tr -d ' ')
          
          echo "current_version=${CURRENT}" >> $GITHUB_OUTPUT
          echo "latest_version=${LATEST}" >> $GITHUB_OUTPUT
          echo "New version found: ${LATEST}"
        fi
        
        cat version-check.log
    
    - name: Check if issue already exists
      if: steps.check.outputs.up_to_date == 'false'
      id: issue_check
      uses: actions/github-script@v7
      with:
        script: |
          const title = `New Claude Desktop version available: ${{ steps.check.outputs.latest_version }}`;
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'version-update'
          });
          
          const existingIssue = issues.data.find(issue => issue.title === title);
          if (existingIssue) {
            console.log(`Issue already exists: #${existingIssue.number}`);
            return existingIssue.number;
          }
          return null;
    
    - name: Create issue for new version
      if: steps.check.outputs.up_to_date == 'false' && !steps.issue_check.outputs.result
      uses: actions/github-script@v7
      with:
        script: |
          const currentVersion = '${{ steps.check.outputs.current_version }}';
          const latestVersion = '${{ steps.check.outputs.latest_version }}';
          
          const body = `## ðŸ†• New Claude Desktop Version Available
          
          A new version of Claude Desktop has been detected!
          
          - **Current version**: \`${currentVersion}\`
          - **Latest version**: \`${latestVersion}\`
          
          ## ðŸ“‹ Update Checklist
          
          - [ ] Update \`pkgver\` in \`PKGBUILD\` to \`${latestVersion}\`
          - [ ] Regenerate \`.SRCINFO\`: \`makepkg --printsrcinfo > .SRCINFO\`
          - [ ] Test build: \`./setup-chroot.sh all\`
          - [ ] Test installation and functionality
          - [ ] Update \`CHANGELOG.md\` with changes
          - [ ] Commit changes: \`git commit -m "Update to version ${latestVersion}"\`
          - [ ] Create release tag: \`git tag v${latestVersion}\`
          - [ ] Push changes and tag
          - [ ] Update AUR (see \`AUR.md\`)
          
          ## ðŸ”— Resources
          
          - [Version Checker Log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Update Guide](https://github.com/${{ github.repository }}/blob/main/README.md#updating)
          - [AUR Publishing Guide](https://github.com/${{ github.repository }}/blob/main/AUR.md)
          
          ---
          
          *This issue was automatically created by the version check workflow.*
          *Run Date: ${new Date().toISOString()}*`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: \`New Claude Desktop version available: \${latestVersion}\`,
            body: body,
            labels: ['version-update', 'enhancement']
          });
    
    - name: Send notification (optional webhook)
      if: steps.check.outputs.up_to_date == 'false' && env.WEBHOOK_URL
      run: |
        curl -X POST "${{ secrets.WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "text": "ðŸ†• New Claude Desktop version available: ${{ steps.check.outputs.latest_version }}",
            "current": "${{ steps.check.outputs.current_version }}",
            "latest": "${{ steps.check.outputs.latest_version }}",
            "repo": "${{ github.repository }}"
          }'
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
